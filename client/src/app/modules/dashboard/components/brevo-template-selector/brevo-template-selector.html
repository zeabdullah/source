<p-toast position="bottom-right" />

<p-dialog
    header="Import Templates from Brevo"
    [visible]="visible()"
    (onHide)="onVisibleChange(false)"
    (onShow)="onVisibleChange(true)"
    [modal]="true"
    [closable]="true"
    [draggable]="false"
    [resizable]="false"
    styleClass="w-full max-w-4xl"
    [baseZIndex]="1000"
>
    <!-- Search and Actions Header -->
    <div class="mb-6 flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
        <div class="flex flex-1 items-center gap-3">
            <i class="pi pi-search text-gray-400"></i>
            <input
                pInputText
                [(ngModel)]="searchQuery"
                placeholder="Search templates by name or subject..."
                class="flex-1"
            />
        </div>

        <div class="flex gap-2">
            <p-button
                label="Select All"
                [outlined]="true"
                size="small"
                (onClick)="selectAllTemplates()"
                [disabled]="availableTemplates().length === 0"
            />
            <p-button
                label="Clear Selection"
                [outlined]="true"
                severity="secondary"
                size="small"
                (onClick)="clearSelection()"
                [disabled]="selectedTemplateIds().length === 0"
            />
        </div>
    </div>

    @if (isLoading()) {
        <div class="flex items-center justify-center py-12">
            <div class="text-center">
                <p-progress-spinner ariaLabel="loading" strokeWidth="4" />
                <p class="text-gray-600 mt-4">Loading Brevo templates...</p>
            </div>
        </div>
    } @else if (brevoTemplates().length === 0) {
        <div class="flex flex-col items-center justify-center py-12">
            <i class="pi pi-inbox text-6xl mb-4 text-gray-300"></i>
            <h3 class="text-lg mb-2 font-semibold">No Brevo Templates Found</h3>
            <p class="text-gray-600 max-w-md text-center">
                You don't have any email templates in your Brevo account, or there was an error
                loading them.
            </p>
        </div>
    } @else {
        <div
            [ngClass]="{
                'grid gap-4 sm:grid-cols-2 lg:grid-cols-3': availableTemplates().length > 0,
            }"
        >
            @for (template of availableTemplates(); track template.id) {
                <p-card
                    class="cursor-pointer transition-all duration-200 hover:shadow-md"
                    [ngClass]="{
                        'ring-2 ring-primary-500': selectedTemplateIds().includes(template.id),
                    }"
                    (click)="toggleTemplateSelection(template.id)"
                >
                    <div class="flex items-start gap-3">
                        <p-checkbox
                            [ngModel]="selectedTemplateIds().includes(template.id)"
                            (onChange)="toggleTemplateSelection(template.id)"
                            (click)="$event.stopPropagation()"
                        />

                        <div class="min-w-0 flex-1">
                            <h4 class="mb-1 truncate font-semibold">{{ template.name }}</h4>

                            @if (template.subject) {
                                <p class="text-gray-600 mb-2 truncate text-sm">
                                    Subject: {{ template.subject }}
                                </p>
                            }

                            <div class="mb-3 text-xs text-gray-500">
                                <div class="flex items-center gap-1">
                                    <i class="pi pi-calendar"></i>
                                    <span>Created: {{ template.createdAt | date: 'short' }}</span>
                                </div>
                                @if (template.modifiedAt !== template.createdAt) {
                                    <div class="mt-1 flex items-center gap-1">
                                        <i class="pi pi-clock"></i>
                                        <span>
                                            Modified: {{ template.modifiedAt | date: 'short' }}
                                        </span>
                                    </div>
                                }
                            </div>

                            <div
                                class="bg-gray-50 max-h-20 overflow-hidden rounded p-2 text-xs text-gray-700"
                            >
                                {{ getTemplatePreview(template) }}
                            </div>

                            <div class="mt-3 flex items-center justify-between">
                                <span
                                    class="inline-flex items-center rounded-full px-2 py-1 text-xs font-medium"
                                    [class]="
                                        template.isActive
                                            ? 'bg-green-100 text-green-800'
                                            : 'text-gray-800 bg-gray-100'
                                    "
                                >
                                    <i class="pi pi-circle-fill mr-1 text-xs"></i>
                                    {{ template.isActive ? 'Active' : 'Inactive' }}
                                </span>
                            </div>
                        </div>
                    </div>
                </p-card>
            } @empty {
                <div class="flex flex-col items-center justify-center py-12">
                    <i class="pi pi-check-circle text-6xl text-green-300 mb-4"></i>
                    <h3 class="text-lg mb-2 font-semibold">All Templates Imported</h3>
                    <p class="text-gray-600 max-w-md text-center">
                        All your Brevo templates have already been imported to this project.
                    </p>
                </div>
            }
        </div>
    }

    <!-- Footer Actions -->
    <ng-template #footer>
        <div class="flex items-center justify-between">
            <div class="text-gray-600 text-sm">
                @if (selectedTemplateIds().length > 0) {
                    <span>{{ selectedTemplateIds().length }} template(s) selected</span>
                } @else {
                    <span>No templates selected</span>
                }
            </div>

            <div class="flex gap-3">
                <p-button
                    label="Cancel"
                    [outlined]="true"
                    severity="secondary"
                    (onClick)="onVisibleChange(false)"
                    [disabled]="isImporting()"
                />
                <p-button
                    label="Import Selected"
                    [loading]="isImporting()"
                    [disabled]="!canImport()"
                    (onClick)="importSelectedTemplates()"
                />
            </div>
        </div>
    </ng-template>
</p-dialog>
