<!-- Fixed overlay for expanded screen (portal-like) -->
@if (shownScreenId() !== null) {
<div class="fixed inset-0 z-[1102] flex items-center justify-center bg-black/20">
    <div class="relative isolate h-full w-full" (click)="closeExpandedScreen()">
        <div class="absolute inset-0 isolate -z-10 bg-black/10"></div>
        <app-screen-details [id]="shownScreenId()!" imgSrc="/app-screen-mobile.png" />
    </div>
</div>
}

<p-drawer
    [(visible)]="drawerVisible"
    header="Screen Details"
    position="right"
    closable="false"
    closeOnEscape="false"
    styleClass="w-full max-w-[450px]"
>
    <div class="flex h-full flex-col">
        <!-- Tab Buttons -->
        <div class="mb-4 flex border-b border-gray-200">
            <p-button
                (onClick)="setActiveTab('comments')"
                [text]="true"
                [severity]="activeTab() === 'comments' ? 'primary' : 'secondary'"
                label="Comments"
                class="flex-1"
                [class]="activeTab() === 'comments' ? 'border-b-2 border-blue-500' : ''"
            />
            <p-button
                (onClick)="setActiveTab('ai-chat')"
                [text]="true"
                [severity]="activeTab() === 'ai-chat' ? 'primary' : 'secondary'"
                label="AI Chat"
                class="flex-1"
                [class]="activeTab() === 'ai-chat' ? 'border-b-2 border-blue-500' : ''"
            />
        </div>

        <!-- Tab Content -->
        <div class="flex-1 overflow-hidden">
            @if (activeTab() === 'comments') {
            <!-- Comments Section -->
            <div class="h-full overflow-y-auto">
                <div class="space-y-6 divide-y divide-black/5">
                    @for (comment of comments; track comment.id) {
                    <div class="flex gap-3 p-3">
                        <p-avatar [image]="comment.user.avatar" size="normal" shape="circle" />
                        <div class="flex-1">
                            <div class="flex items-baseline justify-between gap-2">
                                <span class="text-sm font-semibold">{{ comment.user.name }}</span>
                                <span class="text-xs text-gray-500">
                                    {{ formatDate(comment.date) }}
                                </span>
                            </div>
                            <p class="mt-1 text-[16px] text-gray-700">{{ comment.content }}</p>
                        </div>
                    </div>
                    }
                </div>
            </div>
            } @else {
            <!-- AI Chat Section -->
            <div class="flex h-full flex-col">
                <!-- Chat Messages -->
                <div class="flex-1 space-y-4 overflow-y-auto p-2">
                    @for (message of aiChatMessages(); track message.id) {
                    <div
                        [class]="message.type === 'user' ? 'flex justify-end' : 'flex justify-start'"
                    >
                        <div
                            [class]="message.type === 'user'
                                ? 'max-w-4/5 bg-brand-500 text-white border-brand-500'
                                : 'max-w-4/5 bg-gray-100 border border-gray-200 text-gray-700'"
                            class="rounded-2xl p-4"
                        >
                            <p class="text-sm">{{ message.content + message.content }}</p>
                        </div>
                    </div>
                    }
                </div>

                <!-- Chat Input -->
                <div class="border-t border-gray-200 p-3">
                    <div class="flex gap-2">
                        <input
                            pInputText
                            [(ngModel)]="newMessage"
                            (keydown.enter)="sendMessage()"
                            placeholder="Ask about this screen..."
                            class="flex-1"
                        />
                        <p-button
                            (onClick)="sendMessage()"
                            [disabled]="!newMessage().trim()"
                            icon="pi pi-send"
                            size="large"
                        />
                    </div>
                </div>
            </div>
            }
        </div>
    </div>
</p-drawer>

<!-- Main content area -->
<div class="flex flex-1 flex-col">
    <div class="flex-shrink-0">
        <div class="mb-16 flex gap-4">
            <div class="flex flex-col gap-1">
                <label for="release">Release</label>
                <p-select
                    [options]="releases"
                    [(ngModel)]="selectedRelease"
                    [checkmark]="true"
                    optionLabel="name"
                    optionValue="value"
                    placeholder="Release..."
                    class="w-44 basis-full lg:w-56"
                />
            </div>
            <div class="flex flex-col gap-1">
                <label for="device">Device</label>
                <p-select
                    [options]="devices"
                    [(ngModel)]="selectedDevice"
                    [checkmark]="true"
                    optionLabel="name"
                    optionValue="value"
                    placeholder="Device..."
                    class="w-44 basis-full lg:w-56"
                />
            </div>
            <div class="flex flex-col gap-1">
                <label for="Language">Language</label>
                <p-select
                    [options]="languages"
                    [(ngModel)]="selectedLanguage"
                    [checkmark]="true"
                    optionLabel="name"
                    optionValue="value"
                    placeholder="Language..."
                    class="w-44 basis-full lg:w-56"
                />
            </div>
        </div>

        <div class="space-y-12">
            <section>
                <h3 class="mb-4 font-bold">Signup & Onboarding</h3>
                <div class="scrollbar-hidden flex w-full gap-4 overflow-x-auto">
                    @for (i of [0, 1, 2, 3, 4, 5, 6, 7]; track $index) {
                    <button
                        (click)="showScreenDetails(i)"
                        class="flex min-w-fit items-center justify-center rounded-2xl border border-black/10 bg-gray-100"
                    >
                        <img
                            src="/app-screen-mobile.png"
                            alt=""
                            width="200"
                            class="h-80 w-[260px] object-cover"
                        />
                    </button>
                    }
                </div>
            </section>
            <section>
                <h3 class="mb-4 font-bold">Forgot Password</h3>
                <div class="scrollbar-hidden flex w-full gap-4 overflow-x-auto">
                    @for (i of [0, 1, 2, 3]; track $index) {
                    <button
                        (click)="showScreenDetails(i)"
                        class="flex min-w-fit items-center justify-center rounded-2xl border border-black/10 bg-gray-100"
                    >
                        <img
                            src="/app-screen-mobile.png"
                            alt=""
                            width="200"
                            class="h-80 w-[260px] object-cover"
                        />
                    </button>
                    }
                </div>
            </section>
        </div>
    </div>
</div>
